<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mapillary BBOX Image Fetcher</title>
  
  <!-- MapLibre GL JS CSS -->
  <link href="https://cdn.jsdelivr.net/npm/maplibre-gl@4/dist/maplibre-gl.css" rel="stylesheet" />
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      overflow: hidden;
    }
    
    #map {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 100%;
    }
    
    /* 左上コントロールパネル */
    .control-panel {
      position: absolute;
      top: 10px;
      left: 10px;
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      z-index: 1;
      max-width: 340px;
    }
    
    .control-panel input[type="text"] {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      margin-bottom: 8px;
    }
    
    .control-panel button {
      width: 100%;
      padding: 10px;
      background: #0066cc;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      cursor: pointer;
      font-weight: 600;
      margin-bottom: 8px;
    }
    
    .control-panel button:hover:not(:disabled) {
      background: #0052a3;
    }
    
    .control-panel button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    .control-panel button.secondary {
      background: #28a745;
    }
    
    .control-panel button.secondary:hover:not(:disabled) {
      background: #218838;
    }
    
    .control-panel button.clear {
      background: #6c757d;
    }
    
    .control-panel button.clear:hover {
      background: #5a6268;
    }
    
    .control-panel .hint {
      font-size: 12px;
      color: #666;
      margin-top: 5px;
      line-height: 1.4;
    }
    
    .control-panel .status {
      padding: 8px;
      border-radius: 4px;
      font-size: 13px;
      margin-bottom: 8px;
      display: none;
    }
    
    .control-panel .status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
      display: block;
    }
    
    .control-panel .status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
      display: block;
    }
    
    /* 右上ダウンロードボタン */
    .download-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: white;
      padding: 10px 15px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      z-index: 1;
      border: none;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      color: #333;
    }
    
    .download-btn:hover:not(:disabled) {
      background: #f0f0f0;
    }
    
    .download-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    /* ローディングスピナー */
    .spinner-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.3);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      flex-direction: column;
    }
    
    .spinner-overlay.active {
      display: flex;
    }
    
    .spinner {
      width: 50px;
      height: 50px;
      border: 5px solid #f3f3f3;
      border-top: 5px solid #0066cc;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 15px;
    }
    
    .spinner-overlay p {
      color: white;
      font-size: 16px;
      font-weight: 600;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* トースト通知 */
    .toast {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #333;
      color: white;
      padding: 12px 24px;
      border-radius: 8px;
      z-index: 1001;
      opacity: 0;
      transition: opacity 0.3s;
      max-width: 80%;
      text-align: center;
    }
    
    .toast.show {
      opacity: 1;
    }
    
    .toast.error {
      background: #d32f2f;
    }
    
    .toast.success {
      background: #388e3c;
    }
    
    /* ポップアップ画像スタイル */
    .maplibregl-popup-content {
      padding: 0;
      max-width: 400px;
    }
    
    .maplibregl-popup-content img {
      width: 100%;
      display: block;
      border-radius: 4px;
    }
    
    /* レスポンシブ対応 */
    @media (max-width: 480px) {
      .control-panel {
        max-width: calc(100% - 20px);
        font-size: 13px;
      }
      
      .download-btn {
        font-size: 12px;
        padding: 8px 12px;
      }
    }
  </style>
</head>
<body>
  <!-- 地図 -->
  <div id="map"></div>
  
  <!-- 左上コントロールパネル -->
  <div class="control-panel">
    <input 
      type="text" 
      id="tokenInput" 
      placeholder="Mapillary Access Tokenを入力"
      autocomplete="off"
    />
    <button id="verifyBtn">トークンを検証</button>
    <div class="status" id="tokenStatus"></div>
    <button id="fetchBtn" class="secondary" disabled>現在の画面範囲で取得開始</button>
    <button id="clearBtn" class="clear">クリア</button>
    <div class="hint">地図を移動/ズームして範囲を調整後、取得開始をクリック</div>
  </div>
  
  <!-- 右上ダウンロードボタン -->
  <button id="downloadBtn" class="download-btn" disabled>
    GeoJSONをダウンロード
  </button>
  
  <!-- ローディングスピナー -->
  <div class="spinner-overlay" id="spinnerOverlay">
    <div class="spinner"></div>
    <p id="loadingText">読み込み中...</p>
  </div>
  
  <!-- トースト通知 -->
  <div class="toast" id="toast"></div>
  
  <!-- MapLibre GL JS -->
  <script src="https://cdn.jsdelivr.net/npm/maplibre-gl@4/dist/maplibre-gl.js"></script>
  
  <script>
    // グローバル変数
    let map;
    let geojsonData = null;
    let isTokenValid = false;
    
    // 地図の初期化
    function initMap() {
      map = new maplibregl.Map({
        container: 'map',
        style: {
          version: 8,
          sources: {
            'osm': {
              type: 'raster',
              tiles: ['https://tile.openstreetmap.org/{z}/{x}/{y}.png'],
              tileSize: 256,
              attribution: '© OpenStreetMap contributors'
            }
          },
          layers: [{
            id: 'osm',
            type: 'raster',
            source: 'osm',
            minzoom: 0,
            maxzoom: 19
          }]
        },
        center: [139.7671, 35.6812], // 東京
        zoom: 12
      });
      
      // NavigationControlを追加
      map.addControl(new maplibregl.NavigationControl(), 'top-right');
    }
    
    // トースト表示
    function showToast(message, type = 'info') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `toast ${type} show`;
      
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }
    
    // ローディング表示切り替え
    function setLoading(isLoading, text = '読み込み中...') {
      const overlay = document.getElementById('spinnerOverlay');
      const loadingText = document.getElementById('loadingText');
      loadingText.textContent = text;
      
      if (isLoading) {
        overlay.classList.add('active');
      } else {
        overlay.classList.remove('active');
      }
    }
    
    // トークン検証
    async function verifyToken() {
      const token = document.getElementById('tokenInput').value.trim();
      const statusDiv = document.getElementById('tokenStatus');
      const fetchBtn = document.getElementById('fetchBtn');
      
      if (!token) {
        statusDiv.className = 'status error';
        statusDiv.textContent = 'トークンを入力してください';
        isTokenValid = false;
        fetchBtn.disabled = true;
        return;
      }
      
      setLoading(true, 'トークンを検証中...');
      
      try {
        // Mapillary APIで簡単なクエリを実行してトークンを検証
        // Authorization: OAuth {token} ヘッダーを使用
        // 0.01度 x 0.01度 = 0.0001平方度（制限の0.010平方度より十分小さい）
        const response = await fetch(`https://graph.mapillary.com/images?bbox=139.76,35.68,139.77,35.69&limit=1&fields=id`, {
          headers: {
            'Authorization': `OAuth ${token}`
          }
        });
        
        if (response.ok) {
          const data = await response.json();
          statusDiv.className = 'status success';
          statusDiv.textContent = '✓ トークンは有効です';
          isTokenValid = true;
          fetchBtn.disabled = false;
          showToast('トークンが有効です', 'success');
        } else {
          const errorData = await response.json();
          throw new Error(errorData.error?.message || `認証エラー (${response.status})`);
        }
      } catch (error) {
        console.error('Token verification error:', error);
        statusDiv.className = 'status error';
        statusDiv.textContent = '✗ トークンが無効です: ' + error.message;
        isTokenValid = false;
        fetchBtn.disabled = true;
        showToast('トークンが無効です', 'error');
      } finally {
        setLoading(false);
      }
    }
    
    // 現在の地図のBBOXを取得（面積制限チェック付き）
    function getCurrentBBox() {
      const bounds = map.getBounds();
      const west = bounds.getWest();
      const south = bounds.getSouth();
      const east = bounds.getEast();
      const north = bounds.getNorth();
      
      // BBOX面積を計算（平方度）
      const width = east - west;
      const height = north - south;
      const area = width * height;
      
      // Mapillaryの制限は0.010平方度
      // 安全のため0.009平方度（90%）を上限とする
      const maxArea = 0.009;
      
      if (area > maxArea) {
        // 面積が大きすぎる場合は中心から制限内に縮小
        const centerLon = (west + east) / 2;
        const centerLat = (south + north) / 2;
        
        // 正方形として縮小（安全マージン込み）
        const halfSize = Math.sqrt(maxArea) / 2;
        
        return {
          bbox: `${centerLon - halfSize},${centerLat - halfSize},${centerLon + halfSize},${centerLat + halfSize}`,
          adjusted: true,
          originalArea: area,
          adjustedArea: maxArea
        };
      }
      
      return {
        bbox: `${west},${south},${east},${north}`,
        adjusted: false,
        area: area
      };
    }
    
    // Mapillary APIからデータ取得（ページネーション対応）
    async function fetchMapillaryImages(bbox, accessToken) {
      const allFeatures = [];
      let url = `https://graph.mapillary.com/images?bbox=${bbox}&fields=id,computed_geometry,captured_at,compass_angle,thumb_2048_url&limit=2000`;
      let pageCount = 0;
      
      while (url) {
        pageCount++;
        setLoading(true, `データ取得中... (ページ ${pageCount})`);
        
        const response = await fetch(url, {
          headers: {
            'Authorization': `OAuth ${accessToken}`
          }
        });
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error?.message || `API Error: ${response.status} ${response.statusText}`);
        }
        
        const data = await response.json();
        
        // GeoJSON Featureに変換
        if (data.data && data.data.length > 0) {
          data.data.forEach(item => {
            if (item.computed_geometry) {
              allFeatures.push({
                type: 'Feature',
                geometry: {
                  type: 'Point',
                  coordinates: item.computed_geometry.coordinates
                },
                properties: {
                  id: item.id,
                  captured_at: item.captured_at,
                  thumb_2048_url: item.thumb_2048_url,
                  compass_angle: item.compass_angle
                }
              });
            }
          });
        }
        
        // 次のページがあるか確認
        url = data.paging && data.paging.next ? data.paging.next : null;
      }
      
      return {
        type: 'FeatureCollection',
        features: allFeatures
      };
    }
    
    // 地図上にポイントを表示
    function displayPointsOnMap(geojson) {
      // 既存のレイヤーとソースを削除
      if (map.getLayer('mapillary-points')) {
        map.removeLayer('mapillary-points');
      }
      if (map.getSource('mapillary')) {
        map.removeSource('mapillary');
      }
      
      // 新しいソースとレイヤーを追加
      map.addSource('mapillary', {
        type: 'geojson',
        data: geojson
      });
      
      map.addLayer({
        id: 'mapillary-points',
        type: 'circle',
        source: 'mapillary',
        paint: {
          'circle-radius': 5,
          'circle-color': '#0066cc',
          'circle-stroke-width': 1,
          'circle-stroke-color': '#ffffff'
        }
      });
      
      // クリックイベント：画像をポップアップ表示
      map.on('click', 'mapillary-points', (e) => {
        const feature = e.features[0];
        const props = feature.properties;
        const coords = feature.geometry.coordinates;
        
        const html = `
          <div>
            <img src="${props.thumb_2048_url}" alt="Mapillary Image" style="max-width: 100%;" />
            <p style="padding: 8px; margin: 0; font-size: 12px;">
              <strong>ID:</strong> ${props.id}<br>
              <strong>撮影日時:</strong> ${new Date(props.captured_at).toLocaleString('ja-JP')}
            </p>
          </div>
        `;
        
        new maplibregl.Popup()
          .setLngLat(coords)
          .setHTML(html)
          .addTo(map);
      });
      
      // カーソル変更
      map.on('mouseenter', 'mapillary-points', () => {
        map.getCanvas().style.cursor = 'pointer';
      });
      
      map.on('mouseleave', 'mapillary-points', () => {
        map.getCanvas().style.cursor = '';
      });
    }
    
    // GeoJSONダウンロード
    function downloadGeoJSON() {
      if (!geojsonData) return;
      
      const dataStr = JSON.stringify(geojsonData, null, 2);
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      
      const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
      const filename = `mapillary_images_${timestamp}.geojson`;
      
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
      
      URL.revokeObjectURL(url);
      showToast('GeoJSONをダウンロードしました', 'success');
    }
    
    // 取得開始ボタンのクリックイベント
    async function handleFetchClick() {
      const token = document.getElementById('tokenInput').value.trim();
      
      if (!isTokenValid) {
        showToast('先にトークンを検証してください', 'error');
        return;
      }
      
      // 現在の画面範囲のBBOXを取得（面積制限チェック付き）
      const bboxResult = getCurrentBBox();
      
      // 面積が制限を超えていた場合は警告
      if (bboxResult.adjusted) {
        showToast(`範囲が大きすぎるため自動調整しました（${bboxResult.originalArea.toFixed(4)}→${bboxResult.adjustedArea.toFixed(4)}平方度）`, 'info');
      }
      
      // データ取得開始
      setLoading(true, 'データ取得中...');
      
      try {
        const geojson = await fetchMapillaryImages(bboxResult.bbox, token);
        
        if (geojson.features.length === 0) {
          showToast('この範囲にMapillary画像が見つかりませんでした', 'error');
        } else {
          geojsonData = geojson;
          displayPointsOnMap(geojson);
          document.getElementById('downloadBtn').disabled = false;
          showToast(`${geojson.features.length}件の画像を取得しました`, 'success');
        }
      } catch (error) {
        console.error('Error:', error);
        showToast(`エラーが発生しました: ${error.message}`, 'error');
      } finally {
        setLoading(false);
      }
    }
    
    // クリアボタンのクリックイベント
    function handleClearClick() {
      // Mapillaryポイントをクリア
      if (map.getLayer('mapillary-points')) {
        map.removeLayer('mapillary-points');
      }
      if (map.getSource('mapillary')) {
        map.removeSource('mapillary');
      }
      
      geojsonData = null;
      document.getElementById('downloadBtn').disabled = true;
      
      showToast('クリアしました', 'info');
    }
    
    // イベントリスナー設定
    document.getElementById('verifyBtn').addEventListener('click', verifyToken);
    document.getElementById('fetchBtn').addEventListener('click', handleFetchClick);
    document.getElementById('clearBtn').addEventListener('click', handleClearClick);
    document.getElementById('downloadBtn').addEventListener('click', downloadGeoJSON);
    
    // Enterキーでトークン検証
    document.getElementById('tokenInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        verifyToken();
      }
    });
    
    // 地図初期化
    initMap();
  </script>
</body>
</html>